@using Microsoft.AspNetCore.Builder
@using Microsoft.AspNetCore.Http.Extensions
@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.Extensions.Options

@inject IViewLocalizer Localise
@inject IOptions<RequestLocalizationOptions> LocOptions

@{
    var requestCulture = Context.Features.Get<IRequestCultureFeature>();
    
    var cultureItems = LocOptions.Value.SupportedUICultures!
        .Select(c => new SelectListItem { Value = c.Name, Text = c.DisplayName })
        .ToList();

    var returnUrl = Context.Request.Path.Value;

    var uiCulture = Context.Request.RouteValues["culture"];
    if (uiCulture != null)
    {
        returnUrl = returnUrl?.Replace($"/{uiCulture}", "");
    }
    
    var currentCulture = requestCulture?.RequestCulture.Culture;
}

@* ReSharper disable Html.PathError *@
<form id="unifySelectLanguage" action="@Url.Content("~/unify/i18n")"
      method="post" class="form-unify-i18n form-horizontal" role="form" data-unify-i18n-type="@Environment.GetEnvironmentVariable("UNIFY_I18N_PROVIDER")" data-unify-i18n-provider="@requestCulture?.Provider?.GetType().Name">
    <label asp-for="@requestCulture!.RequestCulture.UICulture.Name">@Localise["Language"]:</label>
    <select name="culture"
            onchange="this.form.submit();"
            asp-for="@requestCulture!.RequestCulture.UICulture.Name" asp-items="cultureItems">
    </select>
    <input type="hidden" name="returnUrl" value="@returnUrl" />
    <input type="hidden" name="currentCulture" value="@currentCulture"/>
    @Html.AntiForgeryToken()
    <noscript><input type="submit" value="Go"/></noscript>
</form>